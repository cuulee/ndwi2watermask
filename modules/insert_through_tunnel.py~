from pymongo import MongoClient
import json
import os
import sys 
from datetime import datetime

orson=False
if(orson):
    pyt="/users/stud09/martinsd/local/miniconda2/envs/gdal/bin/python"
    gdalPol="/users/stud09/martinsd/local/miniconda2/envs/gdal/bin/gdal_polygonize.py"
    proj="/users/stud09/martinsd/proj/sar2watermask"
    scratch="/mnt/scratch/martinsd"
else:
    pyt="/home/delgado/local/miniconda2/bin/python2"
    gdalPol="/home/delgado/local/miniconda2/bin/gdal_polygonize.py"
    proj="/home/delgado/proj/sar2watermask"
    scratch="/home/delgado/scratch"

    
sardir=scratch+"/s1a_scenes"
sarIn=sardir+"/in"
sarOut=sardir+"/out"
polOut=scratch + "/watermasks"
items=os.listdir(polOut)

# for credentials
sys.path.append(os.path.abspath(proj +"/parameters"))

from credentials import *


MONGO_HOST = "141.89.96.184"
MONGO_DB = "sar2watermask"
MONGO_PORT = 27017

ssh = paramiko.SSHClient()
ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
ssh.connect(hostname=MONGO_HOST,username=MONGO_USER,password=MONGO_PASS)
stdin, stdout, stderr = ssh.exec_command('touch $HOME/hello.world')
ssh.close()

client = pymongo.MongoClient('127.0.0.1', server.local_bind_port) # server.local_bind_port is assigned local port
db = client[MONGO_DB]
pprint.pprint(db.collection_names())

server.stop()

client = MongoClient('mongodb://localhost:27017/')
#db = client.sar2watermask ## db
s2w = db.sar2watermask ##  collection


newlist = []

for names in items:
    if names.endswith('simplified.geojson'):
        newlist.append(names)

for in_file in newlist:
    print('\n inserting ' + in_file + ' in mongodb\n')

    with open(polOut + '/' + in_file) as f:
        data = json.load(f)

    
    for feat in data["features"]:
        dttm = datetime.strptime(feat["properties"]["ingestion_time"],"%Y/%m/%d %H:%M:%S+00")
        feat["properties"]["ingestion_time"] = dttm
        #dicio = {"geometry":feat["geometry"],"id_cogerh":feat["properties"]["id_cogerh"]}
        feat_id = s2w.insert_one(feat).inserted_id
        print feat_id

#    print('\n removing ' + in_file + '\n')
#    os.remove(polOut + '/' + in_file)

    


